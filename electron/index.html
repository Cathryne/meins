<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>iWasWhere</title>
</head>
<body style="width:100%; height:100%; margin: 0; padding: 0">
<div>
    <webview src="http://localhost:7777/" style="height:100vh"
             preload="./preload.js"></webview>
</div>
</body>
<script>
    // You can also require other files to run in this process
    require('./renderer.js');

    onload = () => {
        const webview = document.querySelector('webview');
        const {ipcRenderer} = require('electron');

        webview.addEventListener('did-finish-load', () => {
            console.log("close menu");
            let wc = webview.getWebContents();
            wc.executeJavaScript("iwaswhere_web.ui.menu.hide()");
        });

        // Register for IPC events
        ipcRenderer.on('cmd', (event, message) => {
            const webview = document.querySelector('webview');
            console.log("Received cmd:", message.msg);
            ipcRenderer.send('pong', 'pong2');
            const msg = message.msg;
            let wc = webview.getWebContents();

            if (msg === "spellcheck-de") {
                wc.executeJavaScript("window.spellCheckHandler.switchLanguage('de-DE');");
            }
            if (msg === "spellcheck-en") {
                wc.executeJavaScript("window.spellCheckHandler.switchLanguage('en-US');");
            }
            if (msg === "spellcheck-fr") {
                wc.executeJavaScript("window.spellCheckHandler.switchLanguage('fr-FR');");
            }
            if (msg === "spellcheck-es") {
                wc.executeJavaScript("window.spellCheckHandler.switchLanguage('es-ES');");
            }
            if (msg === "spellcheck-it") {
                wc.executeJavaScript("window.spellCheckHandler.switchLanguage('it-IT');");
            }
            if (msg === "spellcheck-none") {
                wc.executeJavaScript("window.spellCheckHandler.currentSpellchecker=null;;")
            }
            if (msg === "hide-menu") {
                wc.executeJavaScript("iwaswhere_web.ui.menu.hide()");
            }
            if (msg === "nav-charts") {
                wc.executeJavaScript("window.location = '/#/charts1'");
            }
            if (msg === "nav-main") {
                wc.executeJavaScript("window.location = '/#/'");
            }
            if (msg === "nav-dashboards") {
                wc.executeJavaScript("window.location = '/#/dashboards/dashboard-1'");
            }
            if (msg === "upload") {
                wc.executeJavaScript("iwaswhere_web.ui.menu.upload()");
            }
            if (msg === "new-entry") {
                wc.executeJavaScript("iwaswhere_web.ui.menu.new_entry()");
            }
            if (msg === "new-story") {
                wc.executeJavaScript("iwaswhere_web.ui.menu.new_story()");
            }
            if (msg === "new-saga") {
                wc.executeJavaScript("iwaswhere_web.ui.menu.new_saga()");
            }
        });

        const handleRedirect = (e, callback) => {
            let url = e.url;
            if (!url.includes("localhost:7777")) {
                require('electron').shell.openExternal(url);
                e.preventDefault();
                e.stopPropagation();
                callback({cancel: true});
                return false;
            }
        };
        webview.addEventListener('will-navigate', handleRedirect);
        webview.addEventListener('new-window', handleRedirect);
    }

</script>
</html>
